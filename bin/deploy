#!/usr/bin/env bash
set -e

echo "ğŸš€ Starting deployment to Heroku..."

# Check if we're in the right directory
if [ ! -f "Gemfile" ]; then
  echo "âŒ Error: Must be run from the Rails root directory"
  exit 1
fi

# Check for uncommitted changes
if ! git diff-index --quiet HEAD --; then
  echo "âš ï¸  Warning: You have uncommitted changes"
  echo "Do you want to continue? (y/N)"
  read -r response
  if [[ ! "$response" =~ ^[Yy]$ ]]; then
    echo "ğŸ›‘ Deployment cancelled"
    exit 1
  fi
fi

# Get current branch
CURRENT_BRANCH=$(git branch --show-current)
echo "ğŸ“Œ Current branch: $CURRENT_BRANCH"

# Verify if pushing from non-main branch is intended
if [ "$CURRENT_BRANCH" != "main" ]; then
  echo "âš ï¸  Warning: You are deploying from branch '$CURRENT_BRANCH' instead of 'main'"
  echo "This will deploy $CURRENT_BRANCH to production."
  echo "Are you sure you want to continue? (y/N)"
  read -r response
  if [[ ! "$response" =~ ^[Yy]$ ]]; then
    echo "ğŸ›‘ Deployment cancelled"
    exit 1
  fi
fi

# Push to Heroku
echo "ğŸ“¤ Pushing to Heroku..."
git push heroku $CURRENT_BRANCH:main

# Run migrations
echo "ğŸ—„ï¸  Running database migrations..."
heroku run rails db:migrate

# Run data migrations
echo "ğŸ“Š Running data migrations..."
heroku run rails db:migrate:with_data

# Check migration status
echo "âœ… Checking migration status..."
heroku run rails db:migrate:status | tail -20

# Run data integrity checks
echo "ğŸ” Running data integrity checks..."
if heroku run rake ci:data_integrity; then
  echo "âœ… Data integrity checks passed"
else
  echo "âš ï¸  Data integrity issues detected - check Heroku logs for details"
fi

# Restart to ensure all changes take effect
echo "ğŸ”„ Restarting app..."
heroku restart

# Check app status
echo "ğŸ¥ Checking app health..."
heroku ps

# Show recent logs
echo "ğŸ“‹ Recent logs:"
heroku logs --tail -n 20

echo "âœ… Deployment complete!"
echo ""
echo "ğŸ”— View app: https://prmetrics.herokuapp.com"
echo "ğŸ“Š View logs: heroku logs --tail"
echo "ğŸš¦ Check status: heroku ps"