#!/usr/bin/env bash
set -e

echo "ğŸš€ Starting deployment to Heroku..."

# Ensure we're on main branch
CURRENT_BRANCH=$(git branch --show-current)
if [ "$CURRENT_BRANCH" != "main" ]; then
  echo "âŒ Error: You must be on the main branch to deploy"
  echo "   Current branch: $CURRENT_BRANCH"
  exit 1
fi

# Check for uncommitted changes
if ! git diff-index --quiet HEAD --; then
  echo "âŒ Error: You have uncommitted changes"
  echo "   Please commit or stash your changes before deploying"
  exit 1
fi

# Run tests
echo "ğŸ§ª Running tests..."
bundle exec rspec

# Push to Heroku
echo "ğŸ“¤ Pushing to Heroku..."
git push heroku main

# Run migrations
echo "ğŸ—„ï¸  Running database migrations..."
heroku run rails db:migrate

# Clear cache
echo "ğŸ§¹ Clearing cache..."
heroku run rails tmp:cache:clear

# Check deployment
echo "âœ… Deployment complete!"
echo "ğŸ” Checking application health..."
heroku run rails runner "puts 'Rails loaded successfully'"

# Show app info
echo ""
echo "ğŸ“Š Application status:"
heroku ps
echo ""
echo "ğŸŒ Application URL:"
heroku info -s | grep web_url

echo ""
echo "âœ¨ Deployment successful!"
echo "ğŸ’¡ Run 'heroku logs --tail' to monitor the application"